<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"tallate.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.18.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="规则引擎介绍什么是规则引擎规则引擎是专家系统的变种，它通过一组规则的集合、通过作用于事实，从而推理得到结果。当一个事实满足某条规则的条件时，就可以认为这个事实与这条规则匹配。比如，如果我的成绩达到 90 分以上就出去旅游，其中的事实是我，规则是if(x的成绩达到90分以上)&amp;#123;x出去玩&amp;#125;  规则可以理解为类似 if-else、switch 这样的代码； 事实在 Java 中可以认">
<meta property="og:type" content="article">
<meta property="og:title" content="规则引擎">
<meta property="og:url" content="https://tallate.github.io/6ce879b3.html">
<meta property="og:site_name" content="Tallate">
<meta property="og:description" content="规则引擎介绍什么是规则引擎规则引擎是专家系统的变种，它通过一组规则的集合、通过作用于事实，从而推理得到结果。当一个事实满足某条规则的条件时，就可以认为这个事实与这条规则匹配。比如，如果我的成绩达到 90 分以上就出去旅游，其中的事实是我，规则是if(x的成绩达到90分以上)&amp;#123;x出去玩&amp;#125;  规则可以理解为类似 if-else、switch 这样的代码； 事实在 Java 中可以认">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://tallate.github.io/imgs/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E/QLExpress%E6%8C%87%E4%BB%A4%E7%94%9F%E6%88%90.png">
<meta property="og:image" content="https://tallate.github.io/imgs/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E/QLExpressDFA%E4%BE%8B%E5%AD%90.png">
<meta property="og:image" content="https://tallate.github.io/imgs/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E/QLExpress-%E8%AF%AD%E6%B3%95%E6%A0%91%E4%BE%8B%E5%AD%90.png">
<meta property="og:image" content="https://tallate.github.io/imgs/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E/QLExpress-%E5%8A%A0%E5%87%8F%E4%B9%98%E9%99%A4%E7%9A%84%E8%AF%AD%E6%B3%95%E5%AE%9A%E4%B9%89.png">
<meta property="og:image" content="https://tallate.github.io/imgs/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E/QLExpress-%E9%80%92%E5%BD%92%E8%A7%A3%E6%9E%90%E4%B9%98%E9%99%A4%E8%AF%AD%E6%B3%95.png">
<meta property="og:image" content="https://tallate.github.io/imgs/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E/QLExpress-%E9%80%92%E5%BD%92%E8%A7%A3%E6%9E%90%E5%8A%A0%E5%87%8F%E8%AF%AD%E6%B3%95.png">
<meta property="og:image" content="https://tallate.github.io/imgs/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E/QLExpress%E6%8C%87%E4%BB%A4%E5%88%9B%E5%BB%BA.png">
<meta property="og:image" content="https://tallate.github.io/imgs/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E/QLExpress%E6%8C%87%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B.png">
<meta property="og:image" content="https://tallate.github.io/imgs/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E/QLExpress%E5%8D%95%E8%AF%8D%E6%89%AB%E6%8F%8F%E4%BE%8B%E5%AD%90.png">
<meta property="og:image" content="https://tallate.github.io/imgs/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E/QLExpress-%E8%AF%AD%E6%B3%95%E6%A0%91%E4%BE%8B%E5%AD%90.png">
<meta property="og:image" content="https://tallate.github.io/imgs/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E/QLExpress%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B.png">
<meta property="og:image" content="https://tallate.github.io/imgs/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E/QLExpress-%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%96%B0%E7%9A%84%E8%AF%AD%E6%B3%95%E6%A0%91%E8%8A%82%E7%82%B9.png">
<meta property="og:image" content="https://tallate.github.io/imgs/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E/QLExpress%E8%87%AA%E5%AE%9A%E4%B9%89%E6%93%8D%E4%BD%9C%E7%AC%A6%E4%B8%8E%E4%B9%98%E5%8F%B7%E7%B1%BB%E4%BC%BC.png">
<meta property="og:image" content="https://tallate.github.io/imgs/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E/QLExpress-%E8%AF%86%E5%88%ABtoken%E4%B8%BA%E5%85%B3%E9%94%AE%E5%AD%97.png">
<meta property="og:image" content="https://tallate.github.io/imgs/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E/QLExpress%E7%B1%BB%E5%9B%BE.png">
<meta property="og:image" content="https://tallate.github.io/imgs/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E/Drools%E4%BE%8B%E5%AD%90%E7%9A%84%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B.png">
<meta property="og:image" content="https://tallate.github.io/imgs/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E%E6%9E%B6%E6%9E%84.png">
<meta property="article:published_time" content="2019-11-20T10:53:22.000Z">
<meta property="article:modified_time" content="2025-07-06T17:56:20.909Z">
<meta property="article:author" content="tallate">
<meta property="article:tag" content="规则引擎">
<meta property="article:tag" content="Drools">
<meta property="article:tag" content="QLExpress">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://tallate.github.io/imgs/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E/QLExpress%E6%8C%87%E4%BB%A4%E7%94%9F%E6%88%90.png">


<link rel="canonical" href="https://tallate.github.io/6ce879b3.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://tallate.github.io/6ce879b3.html","path":"/6ce879b3.html","title":"规则引擎"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>规则引擎 | Tallate</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Tallate</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">该吃吃该喝喝 啥事别往心里搁</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="tags fa-fw"></i>标签<span class="badge">83</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="th fa-fw"></i>分类<span class="badge">25</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="archive fa-fw"></i>归档<span class="badge">189</span></a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E%E4%BB%8B%E7%BB%8D"><span class="nav-number">1.</span> <span class="nav-text">规则引擎介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E"><span class="nav-number">1.1.</span> <span class="nav-text">什么是规则引擎</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BD%BF%E7%94%A8%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E"><span class="nav-number">1.2.</span> <span class="nav-text">为什么使用规则引擎</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#QLExpress"><span class="nav-number">2.</span> <span class="nav-text">QLExpress</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%AD%E6%B3%95"><span class="nav-number">2.1.</span> <span class="nav-text">语法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%93%8D%E4%BD%9C%E7%AC%A6"><span class="nav-number">2.1.1.</span> <span class="nav-text">操作符</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%B9%E8%B1%A1%E6%93%8D%E4%BD%9C"><span class="nav-number">2.1.2.</span> <span class="nav-text">对象操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89-function"><span class="nav-number">2.1.3.</span> <span class="nav-text">自定义 function</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%A9%E5%B1%95%E6%93%8D%E4%BD%9C%E7%AC%A6"><span class="nav-number">2.1.4.</span> <span class="nav-text">扩展操作符</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%91%E5%AE%9A-Java-%E7%B1%BB%E6%88%96%E8%80%85-method"><span class="nav-number">2.1.5.</span> <span class="nav-text">绑定 Java 类或者 method</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#macro-%E5%AE%8F%E5%AE%9A%E4%B9%89"><span class="nav-number">2.1.6.</span> <span class="nav-text">macro 宏定义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%96%E8%AF%91%E8%84%9A%E6%9C%AC%EF%BC%8C%E6%9F%A5%E8%AF%A2%E4%B8%8A%E4%B8%8B%E6%96%87%E4%B8%AD%E9%9C%80%E8%A6%81%E6%8F%90%E4%BE%9B%E7%9A%84%E5%8F%98%E9%87%8F"><span class="nav-number">2.1.7.</span> <span class="nav-text">编译脚本，查询上下文中需要提供的变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8D%E5%AE%9A%E5%8F%82%E6%95%B0"><span class="nav-number">2.1.8.</span> <span class="nav-text">不定参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9B%86%E5%90%88%E6%93%8D%E4%BD%9C"><span class="nav-number">2.1.9.</span> <span class="nav-text">集合操作</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%A7%E8%A1%8C%E5%8E%9F%E7%90%86-%E4%B8%BE%E4%BE%8B"><span class="nav-number">2.2.</span> <span class="nav-text">执行原理 - 举例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%9F%E6%88%90%E6%8C%87%E4%BB%A4%E7%9A%84%E6%B5%81%E7%A8%8B"><span class="nav-number">2.2.1.</span> <span class="nav-text">生成指令的流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8C%87%E4%BB%A4%E7%9A%84%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="nav-number">2.2.2.</span> <span class="nav-text">指令的执行流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BE%8B%EF%BC%9A%E4%B8%80%E4%B8%AA%E8%84%9A%E6%9C%AC%E7%9A%84%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B"><span class="nav-number">2.2.3.</span> <span class="nav-text">例：一个脚本的执行过程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%A7%E8%A1%8C%E5%8E%9F%E7%90%86-%E6%BA%90%E7%A0%81"><span class="nav-number">2.3.</span> <span class="nav-text">执行原理 - 源码</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8D%95%E8%AF%8D%E5%88%86%E8%A7%A3%E3%80%81%E9%A2%84%E5%A4%84%E7%90%86"><span class="nav-number">2.3.1.</span> <span class="nav-text">单词分解、预处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8D%95%E8%AF%8D%E7%B1%BB%E5%9E%8B%E5%88%86%E6%9E%90"><span class="nav-number">2.3.2.</span> <span class="nav-text">单词类型分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AF%AD%E6%B3%95%E5%88%86%E6%9E%90"><span class="nav-number">2.3.3.</span> <span class="nav-text">语法分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%9F%E6%88%90%E8%BF%90%E8%A1%8C%E6%9C%9F%E6%8C%87%E4%BB%A4%E9%9B%86%E5%90%88"><span class="nav-number">2.3.4.</span> <span class="nav-text">生成运行期指令集合</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%A7%E8%A1%8C%E7%94%9F%E6%88%90%E7%9A%84%E6%8C%87%E4%BB%A4%E9%9B%86%E5%90%88"><span class="nav-number">2.3.5.</span> <span class="nav-text">执行生成的指令集合</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%87%BD%E6%95%B0"><span class="nav-number">2.3.6.</span> <span class="nav-text">自定义函数</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#QLExpress-Spring"><span class="nav-number">2.4.</span> <span class="nav-text">QLExpress &amp; Spring</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BC%98%E5%8C%96-%E8%84%9A%E6%9C%AC%E7%BC%93%E5%AD%98"><span class="nav-number">2.5.</span> <span class="nav-text">优化 - 脚本缓存</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BC%98%E5%8C%96-%E5%AF%B9%E8%B1%A1%E6%B1%A0"><span class="nav-number">2.6.</span> <span class="nav-text">优化 - 对象池</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E8%B7%B5-%E6%98%BE%E7%A4%BA%E5%87%BA%E9%94%99%E4%BF%A1%E6%81%AF"><span class="nav-number">2.7.</span> <span class="nav-text">实践 - 显示出错信息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E8%B7%B5-%E7%9F%AD%E8%B7%AF"><span class="nav-number">2.8.</span> <span class="nav-text">实践 - 短路</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E8%B7%B5-%E9%AB%98%E7%B2%BE%E5%BA%A6%E8%AE%A1%E7%AE%97"><span class="nav-number">2.9.</span> <span class="nav-text">实践 - 高精度计算</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E8%B7%B5-%E6%96%B9%E6%B3%95%E7%BB%91%E5%AE%9A"><span class="nav-number">2.10.</span> <span class="nav-text">实践 - 方法绑定</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%8A%80%E6%9C%AF%E9%80%89%E5%9E%8B%E5%8F%8A%E5%AE%9E%E8%B7%B5"><span class="nav-number">3.</span> <span class="nav-text">技术选型及实践</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9C%80%E6%B1%82%E6%8F%8F%E8%BF%B0"><span class="nav-number">3.1.</span> <span class="nav-text">需求描述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%AF%94%E8%BE%83"><span class="nav-number">3.2.</span> <span class="nav-text">比较</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%99%84-Drools"><span class="nav-number">4.</span> <span class="nav-text">附 - Drools</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A7%84%E5%88%99%E7%AE%A1%E7%90%86"><span class="nav-number">4.1.</span> <span class="nav-text">规则管理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A6%82%E5%BF%B5%E5%AE%9A%E4%B9%89"><span class="nav-number">4.2.</span> <span class="nav-text">概念定义</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B"><span class="nav-number">4.3.</span> <span class="nav-text">使用示例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%86%B3%E7%AD%96%E8%A1%A8%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-number">4.4.</span> <span class="nav-text">决策表的使用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E5%8E%9F%E7%94%9FAPI"><span class="nav-number">4.5.</span> <span class="nav-text">使用原生API</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#LHS"><span class="nav-number">4.6.</span> <span class="nav-text">LHS</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RHS"><span class="nav-number">4.7.</span> <span class="nav-text">RHS</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Drools-Spring"><span class="nav-number">4.8.</span> <span class="nav-text">Drools + Spring</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-number">4.9.</span> <span class="nav-text">源码分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E%E8%BF%90%E8%A1%8C%E5%8E%9F%E7%90%86"><span class="nav-number">4.10.</span> <span class="nav-text">规则引擎运行原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A7%84%E5%88%99%E5%8C%B9%E9%85%8D%E7%AE%97%E6%B3%95-RETE"><span class="nav-number">4.11.</span> <span class="nav-text">规则匹配算法 - RETE</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E%E8%A7%84%E8%8C%83-JSR-94"><span class="nav-number">4.12.</span> <span class="nav-text">规则引擎规范 - JSR-94</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-number">5.</span> <span class="nav-text">参考</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%B9%E6%A1%88"><span class="nav-number">5.1.</span> <span class="nav-text">方案</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Drools"><span class="nav-number">5.2.</span> <span class="nav-text">Drools</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#QLExpress-1"><span class="nav-number">5.3.</span> <span class="nav-text">QLExpress</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">tallate</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">189</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">25</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">83</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://tallate.github.io/6ce879b3.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="tallate">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Tallate">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="规则引擎 | Tallate">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          规则引擎
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-11-20 18:53:22" itemprop="dateCreated datePublished" datetime="2019-11-20T18:53:22+08:00">2019-11-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-07-07 01:56:20" itemprop="dateModified" datetime="2025-07-07T01:56:20+08:00">2025-07-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%AE%BE%E8%AE%A1/" itemprop="url" rel="index"><span itemprop="name">设计</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="规则引擎介绍"><a href="#规则引擎介绍" class="headerlink" title="规则引擎介绍"></a>规则引擎介绍</h1><h2 id="什么是规则引擎"><a href="#什么是规则引擎" class="headerlink" title="什么是规则引擎"></a>什么是规则引擎</h2><p><strong>规则引擎</strong>是<strong>专家系统</strong>的变种，它通过一组规则的集合、通过作用于事实，从而推理得到结果。当一个事实满足某条规则的条件时，就可以认为这个事实与这条规则匹配。比如，如果我的成绩达到 90 分以上就出去旅游，其中的事实是<code>我</code>，规则是<code>if(x的成绩达到90分以上)&#123;x出去玩&#125;</code></p>
<ul>
<li>规则<br>可以理解为类似 if-else、switch 这样的代码；</li>
<li>事实<br>在 Java 中可以认为就是类的实例；</li>
</ul>
<h2 id="为什么使用规则引擎"><a href="#为什么使用规则引擎" class="headerlink" title="为什么使用规则引擎"></a>为什么使用规则引擎</h2><ol>
<li>规则引擎实现了数据同逻辑的完全解耦。</li>
<li>有助于规则的集中管理，但是也要注意可能发生的冲突。</li>
<li>每个开发的习惯、水平都不一样，有些人可能会生硬地套用一些设计模式，导致业务逻辑被强行设计得很复杂，而且随着版本、人员迭代越发严重；<br>而规则引擎相当于一套实现业务逻辑的规范，它会逼迫需求和研发人员梳理业务，并建立统一的 BOM（业务对象模型）。</li>
<li>可以使用<strong>决策表</strong>等形式来展示规则，方便业务人员浏览，减少与技术人员沟通成本。</li>
<li>方便业务人员修改业务逻辑，甚至可以做到动态修改、实时生效，减少规则变动带来的额外开发工作。</li>
</ol>
<blockquote>
<p>在复杂的大型业务场景下，规则引擎常和<strong>流程引擎</strong>搭配使用来强化对业务逻辑的管理。</p>
</blockquote>
<span id="more"></span>


<h1 id="QLExpress"><a href="#QLExpress" class="headerlink" title="QLExpress"></a>QLExpress</h1><p>虽然很多文章提到QLExpress是一个规则引擎，但是它本质上是一个脚本引擎，只不过额外提供的自定义关键字功能，使得它的表达能力大大增强，甚至能够达到用中文描述业务逻辑的程度。</p>
<ul>
<li>简洁而强大<br>drl 语法与 Java 很接近，而且可以通过自定义操作符号和别名来实现强大的规则判断。</li>
<li>轻量<br>本体只需要引入一个依赖包。</li>
</ul>
<p>借助 QLExpress，我们可以做到：</p>
<ol>
<li>由产品甚至运营、财务给出具体规则的自然语言描述，比如”<code>如果用户年龄小于12岁则弹出防沉迷公告</code>“；</li>
<li>由程序解析这些自然语言为程序识别的表达式，比如”<code>if(age &lt; 12) &#123;notifyService.push(msg);&#125;</code>“；</li>
<li>计算结果，最终实现业务逻辑。</li>
</ol>
<p>相对 Drools 来说，QLExpress 少了很多规则管理功能，比如大量重复的条件匹配、规则的冲突等情况如何应对，落地时需要做很多扩展开发工作。当然，优点也出于其轻量性，实际业务场景并不一定适用于 Drools 这套重量级的规则模型，由于学习成本高、灵活性差，RETE 算法可能并不能发挥其优势，反而因为初始化成本过高而起到反作用。</p>
<h2 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h2><h3 id="操作符"><a href="#操作符" class="headerlink" title="操作符"></a>操作符</h3><p>基本操作符支持：+,-,*,&#x2F;,&lt;,&gt;,&lt;&#x3D;,&gt;&#x3D;,&#x3D;&#x3D;,!&#x3D;,%,++,–,&amp;&amp;,||,!<br>有几个比较特殊的：&lt;&gt;（等同于!&#x3D;）、mod（取模等同于%）、in（类似 sql）、like（sql 语法）<br>三元操作符：? :<br>程序流控制支持：for、break、continue、if-then-else</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">String expression = &quot;sum = 0;&quot;</span><br><span class="line">        + &quot;for (i = 0; i &lt; 10; i++) &#123;&quot;</span><br><span class="line">        + &quot;sum = sum + i;&quot;</span><br><span class="line">        + &quot;&#125;&quot;</span><br><span class="line">        + &quot;return sum;&quot;;</span><br><span class="line">ExpressRunner runner = new ExpressRunner(false, true);</span><br><span class="line">Object result = runner.execute(expression, new DefaultContext&lt;&gt;(), null, false, true);</span><br><span class="line">System.out.println(result);</span><br></pre></td></tr></table></figure>

<h3 id="对象操作"><a href="#对象操作" class="headerlink" title="对象操作"></a>对象操作</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// 系统自动会import java.lang.*,import java.util.*;</span><br><span class="line">import com.ql.util.express.test.OrderQuery;</span><br><span class="line"></span><br><span class="line">query = new OrderQuery();//创建class实例,会根据classLoader信息，自动补全类路径</span><br><span class="line">query.setCreateDate(new Date());//设置属性</span><br><span class="line">query.buyer = &quot;张三&quot;;//调用属性,默认会转化为setBuyer(&quot;张三&quot;)</span><br><span class="line">result = bizOrderDAO.query(query);//调用bean对象的方法</span><br><span class="line">System.out.println(result.getId());//静态方法</span><br></pre></td></tr></table></figure>

<h3 id="自定义-function"><a href="#自定义-function" class="headerlink" title="自定义 function"></a>自定义 function</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">function add(int a,int b)&#123;</span><br><span class="line">  return a+b;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">function sub(int a,int b)&#123;</span><br><span class="line">  return a - b;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">a=10;</span><br><span class="line">return add(a,4) + sub(a,9);</span><br></pre></td></tr></table></figure>

<h3 id="扩展操作符"><a href="#扩展操作符" class="headerlink" title="扩展操作符"></a>扩展操作符</h3><p>替换 if、then、else 等关键字（<code>addOperatorWithAlias</code>）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">runner.addOperatorWithAlias(&quot;如果&quot;, &quot;if&quot;,null);</span><br><span class="line">runner.addOperatorWithAlias(&quot;则&quot;, &quot;then&quot;,null);</span><br><span class="line">runner.addOperatorWithAlias(&quot;否则&quot;, &quot;else&quot;,null);</span><br><span class="line"></span><br><span class="line">exp = &quot;如果  (如果 1==2 则 false 否则 true) 则 &#123;2+2;&#125; 否则 &#123;20 + 20;&#125;&quot;;</span><br><span class="line">DefaultContext&lt;String, Object&gt; context = new DefaultContext&lt;String, Object&gt;();</span><br><span class="line">runner.execute(exp,nil,null,false,false,null);</span><br></pre></td></tr></table></figure>

<p>自定义 Operator（<code>Operator</code>）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">//定义一个继承自com.ql.util.express.Operator的操作符</span><br><span class="line">public class JoinOperator extends Operator &#123;</span><br><span class="line">    public Object executeInner(Object[] list) throws Exception &#123;</span><br><span class="line">        Object opdata1 = list[0];</span><br><span class="line">        Object opdata2 = list[1];</span><br><span class="line">        if(opdata1 instanceof java.util.List)&#123;</span><br><span class="line">            ((java.util.List)opdata1).add(opdata2);</span><br><span class="line">            return opdata1;</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            java.util.List result = new java.util.ArrayList();</span><br><span class="line">            result.add(opdata1);</span><br><span class="line">            result.add(opdata2);</span><br><span class="line">            return result;              </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// addOperator</span><br><span class="line">ExpressRunner runner = new ExpressRunner();</span><br><span class="line">DefaultContext&lt;String, Object&gt; context = new DefaultContext&lt;String, Object&gt;();</span><br><span class="line">runner.addOperator(&quot;join&quot;,new JoinOperator());</span><br><span class="line">Object r = runner.execute(&quot;1 join 2 join 3&quot;, context, null, false, false);</span><br><span class="line">System.out.println(r);</span><br><span class="line">// 返回结果  [1, 2, 3]</span><br><span class="line"></span><br><span class="line">// replaceOperator</span><br><span class="line">ExpressRunner runner = new ExpressRunner();</span><br><span class="line">DefaultContext&lt;String, Object&gt; context = new DefaultContext&lt;String, Object&gt;();</span><br><span class="line">runner.replaceOperator(&quot;+&quot;,new JoinOperator());</span><br><span class="line">Object r = runner.execute(&quot;1 + 2 + 3&quot;, context, null, false, false);</span><br><span class="line">System.out.println(r);</span><br><span class="line">// 返回结果  [1, 2, 3]</span><br><span class="line"></span><br><span class="line">// addFunction</span><br><span class="line">ExpressRunner runner = new ExpressRunner();</span><br><span class="line">DefaultContext&lt;String, Object&gt; context = new DefaultContext&lt;String, Object&gt;();</span><br><span class="line">runner.addFunction(&quot;join&quot;,new JoinOperator());</span><br><span class="line">Object r = runner.execute(&quot;join(1,2,3)&quot;, context, null, false, false);</span><br><span class="line">System.out.println(r);</span><br><span class="line">// 返回结果  [1, 2, 3]</span><br></pre></td></tr></table></figure>

<h3 id="绑定-Java-类或者-method"><a href="#绑定-Java-类或者-method" class="headerlink" title="绑定 Java 类或者 method"></a>绑定 Java 类或者 method</h3><p><code>addFunctionOfClassMethod</code>、<code>addFunctionOfServiceMethod</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void testBindJavaClassAndMethod() throws Exception &#123;</span><br><span class="line">    ExpressRunner runner = new ExpressRunner();</span><br><span class="line">    runner.addFunctionOfClassMethod(&quot;取绝对值&quot;, Math.class.getName(), &quot;abs&quot;,</span><br><span class="line">            new String[]&#123;&quot;double&quot;&#125;, null);</span><br><span class="line">    runner.addFunctionOfClassMethod(&quot;转换为大写&quot;, BeanExample.class.getName(),</span><br><span class="line">            &quot;upper&quot;, new String[]&#123;&quot;String&quot;&#125;, null);</span><br><span class="line"></span><br><span class="line">    runner.addFunctionOfServiceMethod(&quot;打印&quot;, System.out, &quot;println&quot;, new String[]&#123;&quot;String&quot;&#125;, null);</span><br><span class="line">    runner.addFunctionOfServiceMethod(&quot;contains&quot;, new BeanExample(), &quot;anyContains&quot;,</span><br><span class="line">            new Class[]&#123;String.class, String.class&#125;, null);</span><br><span class="line"></span><br><span class="line">    DefaultContext&lt;String, Object&gt; context = new DefaultContext&lt;String, Object&gt;();</span><br><span class="line">    String exp = &quot;取绝对值(-100);转换为大写(\&quot;hello world\&quot;);打印(\&quot;你好吗？\&quot;); contains(\&quot;helloworld\&quot;, \&quot;asd\&quot;)&quot;;</span><br><span class="line">    runner.execute(exp, context, null, false, false);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public class BeanExample &#123;</span><br><span class="line"></span><br><span class="line">    public static String upper(String abc) &#123;</span><br><span class="line">        return abc.toUpperCase();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public boolean anyContains(String str, String searchStr) &#123;</span><br><span class="line"></span><br><span class="line">        char[] s = str.toCharArray();</span><br><span class="line">        for (char c : s) &#123;</span><br><span class="line">            if (searchStr.contains(c + &quot;&quot;)) &#123;</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="macro-宏定义"><a href="#macro-宏定义" class="headerlink" title="macro 宏定义"></a>macro 宏定义</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void testMicro() throws Exception &#123;</span><br><span class="line">    ExpressRunner runner = new ExpressRunner();</span><br><span class="line">    runner.addMacro(&quot;计算平均成绩&quot;, &quot;(语文+数学+英语)/3.0&quot;);</span><br><span class="line">    runner.addMacro(&quot;是否优秀&quot;, &quot;计算平均成绩&gt;90&quot;);</span><br><span class="line">    IExpressContext&lt;String, Object&gt; context = new DefaultContext&lt;&gt;();</span><br><span class="line">    context.put(&quot;语文&quot;, 88);</span><br><span class="line">    context.put(&quot;数学&quot;, 99);</span><br><span class="line">    context.put(&quot;英语&quot;, 95);</span><br><span class="line">    Object result = runner.execute(&quot;是否优秀&quot;, context, null, false, false);</span><br><span class="line">    System.out.println(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="编译脚本，查询上下文中需要提供的变量"><a href="#编译脚本，查询上下文中需要提供的变量" class="headerlink" title="编译脚本，查询上下文中需要提供的变量"></a>编译脚本，查询上下文中需要提供的变量</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void testOutParam() throws Exception &#123;</span><br><span class="line">    String express = &quot;int 平均分 = (语文+数学+英语+综合考试.科目2)/4.0;return 平均分&quot;;</span><br><span class="line">    ExpressRunner runner = new ExpressRunner(true, true);</span><br><span class="line">    String[] names = runner.getOutVarNames(express);</span><br><span class="line">    for (String s : names) &#123;</span><br><span class="line">        System.out.println(&quot;var : &quot; + s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="不定参数"><a href="#不定参数" class="headerlink" title="不定参数"></a>不定参数</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void testMethodReplace() throws Exception &#123;</span><br><span class="line">    ExpressRunner runner = new ExpressRunner();</span><br><span class="line">    IExpressContext&lt;String, Object&gt; expressContext = new DefaultContext&lt;String, Object&gt;();</span><br><span class="line">    runner.addFunctionOfServiceMethod(&quot;getTemplate&quot;, this, &quot;getTemplate&quot;, new Class[]&#123;Object[].class&#125;, null);</span><br><span class="line"></span><br><span class="line">    // 默认的不定参数可以使用数组来代替</span><br><span class="line">    Object r = runner.execute(&quot;getTemplate([11,&#x27;22&#x27;,33L,true])&quot;, expressContext, null, false, false);</span><br><span class="line">    System.out.println(r);</span><br><span class="line">    // 像java一样,支持函数动态参数调用,需要打开以下全局开关,否则以下调用会失败</span><br><span class="line">    DynamicParamsUtil.supportDynamicParams = true;</span><br><span class="line">    r = runner.execute(&quot;getTemplate(11,&#x27;22&#x27;,33L,true)&quot;, expressContext, null, false, false);</span><br><span class="line">    System.out.println(r);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 等价于getTemplate(Object[] params)</span><br><span class="line">public Object getTemplate(Object... params) throws Exception &#123;</span><br><span class="line">    StringBuilder result = new StringBuilder();</span><br><span class="line">    for (Object obj : params) &#123;</span><br><span class="line">        result.append(obj).append(&quot; &quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    return result.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="集合操作"><a href="#集合操作" class="headerlink" title="集合操作"></a>集合操作</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void testSet() throws Exception &#123;</span><br><span class="line">    ExpressRunner runner = new ExpressRunner(false, false);</span><br><span class="line">    DefaultContext&lt;String, Object&gt; context = new DefaultContext&lt;String, Object&gt;();</span><br><span class="line">    String express = &quot;abc = NewMap(1:1,2:2); return abc.get(1) + abc.get(2);&quot;;</span><br><span class="line">    Object r = runner.execute(express, context, null, false, false);</span><br><span class="line">    System.out.println(r);</span><br><span class="line">    express = &quot;abc = NewList(1,2,3); return abc.get(1)+abc.get(2)&quot;;</span><br><span class="line">    r = runner.execute(express, context, null, false, false);</span><br><span class="line">    System.out.println(r);</span><br><span class="line">    express = &quot;abc = [1,2,3]; return abc[1]+abc[2];&quot;;</span><br><span class="line">    r = runner.execute(express, context, null, false, false);</span><br><span class="line">    System.out.println(r);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 集合遍历，不支持for(obj:list)&#123;&#125;的语法，只能通过下标访问</span><br><span class="line">@Test</span><br><span class="line">public void testTraversal() throws Exception &#123;</span><br><span class="line">    String expression = &quot;map = new HashMap();\n&quot;</span><br><span class="line">            + &quot;map.put(\&quot;a\&quot;, \&quot;a_value\&quot;);\n&quot;</span><br><span class="line">            + &quot;map.put(\&quot;b\&quot;, \&quot;b_value\&quot;);\n&quot;</span><br><span class="line">            + &quot;keySet = map.keySet();\n&quot;</span><br><span class="line">            + &quot;objArr = keySet.toArray();\n&quot;</span><br><span class="line">            + &quot;for (i = 0; i &lt; objArr.length; i++) &#123;\n&quot;</span><br><span class="line">            + &quot;    key = objArr[i];\n&quot;</span><br><span class="line">            + &quot;    System.out.println(map.get(key));\n&quot;</span><br><span class="line">            + &quot;&#125;&quot;;</span><br><span class="line">    ExpressRunner runner = new ExpressRunner();</span><br><span class="line">    DefaultContext&lt;String, Object&gt; context = new DefaultContext&lt;&gt;();</span><br><span class="line">    runner.execute(expression, context, null, false, false);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="执行原理-举例"><a href="#执行原理-举例" class="headerlink" title="执行原理 - 举例"></a>执行原理 - 举例</h2><h3 id="生成指令的流程"><a href="#生成指令的流程" class="headerlink" title="生成指令的流程"></a>生成指令的流程</h3><p><img src="/imgs/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E/QLExpress%E6%8C%87%E4%BB%A4%E7%94%9F%E6%88%90.png" alt="QLExpress指令生成" title="QLExpress指令生成"><br>1、单词扫描及识别<br>通过有限状态机识别脚本为一个个 token（ExpressParse#splitWords）<br><img src="/imgs/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E/QLExpressDFA%E4%BE%8B%E5%AD%90.png" alt="QLExpressDFA例子" title="QLExpressDFA例子"><br>识别单词类型，比如 100d 是 double 类型浮点数，而 100l 是 long 类型的整数，上一步并不会确定这二者的区别（ExpressParse#transferWord2ExpressNode）。<br>2、语法分析<br>采用递归向下分析语法（com.ql.util.express.match.QLPattern#findMatchStatement）。<br>以一个简单的加减乘除为例，假设 Expr 表示识别一个表达式，Term 表示乘积或商，Factor 是表达式中的数字：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Expr -&gt; Expr + Term</span><br><span class="line">      | Expr - Term</span><br><span class="line">      | Term</span><br><span class="line"></span><br><span class="line">Term -&gt; Term * Factor</span><br><span class="line">      | Term / Factor</span><br><span class="line">      | Factor</span><br></pre></td></tr></table></figure>
<p>这里的箭头”-&gt;”有”由……组成”的含义，”Expr -&gt; Expr + Term”即表达式是由表达式和某个 Term 之间的和组成，这个定义是递归的。示例实现如下（下面代码并非 QLExpress 中的代码）：<br><img src="/imgs/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E/QLExpress-%E8%AF%AD%E6%B3%95%E6%A0%91%E4%BE%8B%E5%AD%90.png" alt="QLExpress-语法树例子" title="QLExpress-语法树例子"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">static TreeNode *additive_expression(void) &#123;</span><br><span class="line">    TreeNode *root = term();</span><br><span class="line">    while(token == PLUS || token == MINUS) &#123;</span><br><span class="line">        /* 将+ -符号当作新的根 */</span><br><span class="line">        TreeNode *newRoot = newExpNode(OpE);</span><br><span class="line">        if(newRoot) &#123;</span><br><span class="line">            newRoot-&gt;child[0] = root;</span><br><span class="line">            newRoot-&gt;attr.op = token;</span><br><span class="line">            root = newRoot;</span><br><span class="line">        &#125;</span><br><span class="line">        match(token);</span><br><span class="line">        if(root) &#123;</span><br><span class="line">            root-&gt;child[1] = additive_expression();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return root;</span><br><span class="line">&#125;</span><br><span class="line">static TreeNode *term(void) &#123;</span><br><span class="line">    TreeNode *root = factor();</span><br><span class="line">    while(token == TIMES || token == OVER) &#123;</span><br><span class="line">        /* 将* /符号当作新的根 */</span><br><span class="line">        TreeNode *newRoot = newExpNode(OpE);</span><br><span class="line">        if(newRoot) &#123;</span><br><span class="line">            newRoot-&gt;child[0] = root;</span><br><span class="line">            newRoot-&gt;attr.op = token;</span><br><span class="line">            root = newRoot;</span><br><span class="line">        &#125;</span><br><span class="line">        match(token);</span><br><span class="line">        if(root) &#123;</span><br><span class="line">            root-&gt;child[1] = term();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return root;</span><br><span class="line">&#125;</span><br><span class="line">static TreeNode *factor(void) &#123;</span><br><span class="line">    TreeNode *root = NULL;</span><br><span class="line">    switch(token) &#123;</span><br><span class="line">    case LPAREN:</span><br><span class="line">        match(LPAREN);</span><br><span class="line">        root = expression();</span><br><span class="line">        match(RPAREN);</span><br><span class="line">        break;</span><br><span class="line">    case NUM:</span><br><span class="line">        root = newExpNode(ConstE);</span><br><span class="line">        if(root) &#123; root-&gt;attr.val = atoi(tokenString); &#125;</span><br><span class="line">        match(NUM);</span><br><span class="line">        break;</span><br><span class="line">    case ID:</span><br><span class="line">        root = var_call();</span><br><span class="line">        break;</span><br><span class="line">    default:</span><br><span class="line">        syntaxError(&quot;unexpected token -&gt; &quot;);</span><br><span class="line">        printToken(token, tokenString);</span><br><span class="line">        token = getToken();</span><br><span class="line">    &#125;</span><br><span class="line">    return root;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实际 QLExpress 的语法定义比较复杂（com.ql.util.express.parse.KeyWordDefine4Java#nodeTypeDefines），像上面的加减乘除语法定义如下：<br><img src="/imgs/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E/QLExpress-%E5%8A%A0%E5%87%8F%E4%B9%98%E9%99%A4%E7%9A%84%E8%AF%AD%E6%B3%95%E5%AE%9A%E4%B9%89.png" alt="QLExpress-加减乘除的语法定义" title="QLExpress-加减乘除的语法定义"><br>以下面这个简单的加减乘除脚本为例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a+b*c</span><br></pre></td></tr></table></figure>
<p><img src="/imgs/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E/QLExpress-%E9%80%92%E5%BD%92%E8%A7%A3%E6%9E%90%E4%B9%98%E9%99%A4%E8%AF%AD%E6%B3%95.png" alt="QLExpress-递归解析乘除语法" title="QLExpress-递归解析乘除语法"><br><img src="/imgs/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E/QLExpress-%E9%80%92%E5%BD%92%E8%A7%A3%E6%9E%90%E5%8A%A0%E5%87%8F%E8%AF%AD%E6%B3%95.png" alt="QLExpress-递归解析加减语法" title="QLExpress-递归解析加减语法"><br>如上图所示，递归深度直到达到 22、23 才开始识别脚本中的乘法和加法表达式。<br>3、创建指令<br><img src="/imgs/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E/QLExpress%E6%8C%87%E4%BB%A4%E5%88%9B%E5%BB%BA.png" alt="QLExpress指令创建" title="QLExpress指令创建"><br>不同指令有对应的工厂类负责创建，不同指令的生成方式并不一致，比如：</p>
<ul>
<li>二元表达式的生成方式是后序遍历语法树，即先把左子树和右子树的结果算出来，再取它们之间的和差积商等（com.ql.util.express.instruction.OperatorInstructionFactory）；</li>
<li>函数调用表达式的生成方式是先计算第 2 个及之后的所有子树结果（方法调用实参），然后计算该函数本身。</li>
</ul>
<h3 id="指令的执行流程"><a href="#指令的执行流程" class="headerlink" title="指令的执行流程"></a>指令的执行流程</h3><p><img src="/imgs/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E/QLExpress%E6%8C%87%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B.png" alt="QLExpress指令执行流程" title="QLExpress指令执行流程"><br>1、将用户传参保存到上下文（com.ql.util.express.InstructionSetRunner#execute）<br>很多指令需要用到上下文中的参数，比如像”*”这样的操作符（com.ql.util.express.Operator）。<br>通过自定义这个上下文，我们还可以实现在脚本里使用 Spring 容器中的 Bean，后面我们会给出例子。<br>2、执行指令（com.ql.util.express.InstructionSet#executeInnerOrigiInstruction）<br>指令计算遵循栈模型：计算表达式时，从栈顶取参，并将结果压回栈顶。</p>
<ul>
<li>常量表达式就是将常量压入栈顶（com.ql.util.express.instruction.detail.InstructionConstData）</li>
<li>类似乘法这样的二元操作符，计算时一般使用上下文提供的参数计算结果，然后压回栈中（com.ql.util.express.instruction.detail.InstructionOperator）<br>比如，”*”计算的是乘积（com.ql.util.express.instruction.op.OperatorMultiDiv）</li>
</ul>
<h3 id="例：一个脚本的执行过程"><a href="#例：一个脚本的执行过程" class="headerlink" title="例：一个脚本的执行过程"></a>例：一个脚本的执行过程</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ExpressRunner runner = new ExpressRunner();</span><br><span class="line">DefaultContext&lt;String, Object&gt; context = new DefaultContext&lt;String, Object&gt;();</span><br><span class="line">context.put(&quot;a&quot;,1);</span><br><span class="line">context.put(&quot;b&quot;,2);</span><br><span class="line">context.put(&quot;c&quot;,3);</span><br><span class="line">String express = &quot;a+b*c&quot;;</span><br><span class="line">Object r = runner.execute(express, context, null, true, false);</span><br><span class="line">System.out.println(r);</span><br></pre></td></tr></table></figure>
<p>可见，脚本内容很简单，为”a+b*c”，并且传入了 a、b、c 三个参数的值。<br>1、脚本编译<br>脚本编译的目标是生成中间指令，会经过单词扫描识别、语法分析、创建指令 3 个过程。<br>扫描得到的单词列表如下图所示：<br><img src="/imgs/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E/QLExpress%E5%8D%95%E8%AF%8D%E6%89%AB%E6%8F%8F%E4%BE%8B%E5%AD%90.png" alt="QLExpress单词扫描例子" title="QLExpress单词扫描例子"><br>生成语法树如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1:   STAT_BLOCK:STAT_BLOCK                                                         	STAT_BLOCK</span><br><span class="line">2:      STAT_SEMICOLON:STAT_SEMICOLON	STAT_SEMICOLON</span><br><span class="line">3:         +:+	+</span><br><span class="line">4:            a:ID	ID</span><br><span class="line">4:            *:*	*</span><br><span class="line">5:               b:ID	ID</span><br><span class="line">5:               c:ID	ID</span><br></pre></td></tr></table></figure>
<p><img src="/imgs/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E/QLExpress-%E8%AF%AD%E6%B3%95%E6%A0%91%E4%BE%8B%E5%AD%90.png" alt="QLExpress-语法树例子" title="QLExpress-语法树例子"><br>创建的指令如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1:LoadAttr:a</span><br><span class="line">2:LoadAttr:b</span><br><span class="line">3:LoadAttr:c</span><br><span class="line">4:OP : * OPNUMBER[2]</span><br><span class="line">5:OP : + OPNUMBER[2]</span><br></pre></td></tr></table></figure>
<p>2、运行指令<br>第一步：LoadAttr 指令从上下文获取变量 a 的值——这里即 1，压入运行时栈中（com.ql.util.express.instruction.detail.InstructionLoadAttr）<br>第二步：同理<br>第三步：同理<br>第四步：”*”操作符的指令会先从栈顶弹出俩参数，计算乘积再压回栈中（com.ql.util.express.instruction.detail.InstructionOperator）<br>第五步：同理</p>
<h2 id="执行原理-源码"><a href="#执行原理-源码" class="headerlink" title="执行原理 - 源码"></a>执行原理 - 源码</h2><p>QLExpress 本质上是一个解释器，下面我们来分析一下它的执行流程。<br>下面这个例子是官方提供的，会在执行过程中打出关键步骤的执行结果，可作为原理分析的参考：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void testDemo() throws Exception&#123;</span><br><span class="line">    String express = &quot;10 * 10 + 1 + 2 * 3 + 5 * 2&quot;;</span><br><span class="line">    ExpressRunner runner = new ExpressRunner(false,true); // 显示执行编译过程</span><br><span class="line">    Object r = runner.execute(express,null, null, false,true); // 显示指令执行过程</span><br><span class="line">    Assert.assertTrue(&quot;表达式计算&quot;, r.toString().equalsIgnoreCase(&quot;117&quot;));</span><br><span class="line">    System.out.println(&quot;表达式计算：&quot; + express + &quot; = &quot; + r);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/imgs/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E/QLExpress%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B.png" alt="QLExpress执行流程" title="QLExpress执行流程"></p>
<p>其中：</p>
<ul>
<li>运行时上下文包括用户输入、系统变量及 Spring 上下文管理的所有 Bean 等。</li>
<li>Runner 负责对脚本的编译和执行，及高精度、逻辑短路、自定义 field、自定义 function、宏等特性。</li>
</ul>
<h3 id="单词分解、预处理"><a href="#单词分解、预处理" class="headerlink" title="单词分解、预处理"></a>单词分解、预处理</h3><ol>
<li><code>wordSplit.parse</code><br>第一次 parse<br>遍历目标字符串，使用预定义的分隔符分割，得到 token。</li>
<li><code>ExpressParse#dealInclude</code><br>预处理，qlexpress 支持使用 include 引入其他脚本文件。</li>
<li><code>ExpressParse#fetchSelfDefineClass</code><br>获取用户自定义的 class。</li>
</ol>
<h3 id="单词类型分析"><a href="#单词类型分析" class="headerlink" title="单词类型分析"></a>单词类型分析</h3><p>ExpressParse#transferWord2ExpressNode</p>
<h3 id="语法分析"><a href="#语法分析" class="headerlink" title="语法分析"></a>语法分析</h3><p>QLPattern#findMatchStatement</p>
<h3 id="生成运行期指令集合"><a href="#生成运行期指令集合" class="headerlink" title="生成运行期指令集合"></a>生成运行期指令集合</h3><p>ExpressRunner#createInstructionSet(ExpressNode root, String type)</p>
<h3 id="执行生成的指令集合"><a href="#执行生成的指令集合" class="headerlink" title="执行生成的指令集合"></a>执行生成的指令集合</h3><p>InstructionSetRunner#executeOuter</p>
<h3 id="自定义函数"><a href="#自定义函数" class="headerlink" title="自定义函数"></a>自定义函数</h3><p>1、添加函数定义（com.ql.util.express.ExpressRunner#addFunction、addFunctionOfClassMethod、addFunctionOfServiceMethod）<br>添加到 OperatorFactory 和 NodeTypeManager，前者用于创建指令，后者用于单词识别时判断节点是否是函数。<br>使用 SpringBean 时，Bean 的生命周期仍然由 Spring 控制，QLExpress 只是使用了该 Bean 的引用。<br>2、扫描时识别 token 为方法并做标记（com.ql.util.express.parse.ExpressParse#transferWord2ExpressNode）<br>创建一个新的语法树节点（ExpressNode）。<br><img src="/imgs/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E/QLExpress-%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%96%B0%E7%9A%84%E8%AF%AD%E6%B3%95%E6%A0%91%E8%8A%82%E7%82%B9.png" alt="QLExpress-创建一个新的语法树节点" title="QLExpress-创建一个新的语法树节点"><br>3、创建指令时，对应这种节点（ExpressNode）创建一个函数调用指令（com.ql.util.express.instruction.CallFunctionInstructionFactory）<br>4、执行自定义函数对应的指令（com.ql.util.express.instruction.detail.InstructionOperator#execute）<br>通过反射调用对象中的方法（com.ql.util.express.instruction.op.OperatorSelfDefineClassFunction）。</p>
<p>###自定义操作符<br>1、添加操作符定义（com.ql.util.express.ExpressRunner#addOperator）<br>与自定义函数类似，这些指令会被添加到 OperatorFactory 和 NodeTypeManager。<br>自定义操作符的优先级、语法和乘法”*”一致，后面生成指令时用的是同一个 OperatorInstructionFactory，需要实现 Operator 基类自定义操作符的处理逻辑。<br><img src="/imgs/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E/QLExpress%E8%87%AA%E5%AE%9A%E4%B9%89%E6%93%8D%E4%BD%9C%E7%AC%A6%E4%B8%8E%E4%B9%98%E5%8F%B7%E7%B1%BB%E4%BC%BC.png" alt="QLExpress自定义操作符与乘号类似" title="QLExpress自定义操作符与乘号类似"><br>2、扫描阶段识别 token，这些 token 会被识别为“关键字”（com.ql.util.express.parse.ExpressParse#transferWord2ExpressNode）<br><img src="/imgs/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E/QLExpress-%E8%AF%86%E5%88%ABtoken%E4%B8%BA%E5%85%B3%E9%94%AE%E5%AD%97.png" alt="QLExpress-识别token为关键字" title="QLExpress-识别token为关键字"><br>3、创建操作指令（com.ql.util.express.instruction.OperatorInstructionFactory）<br>4、执行自定义操作符（com.ql.util.express.instruction.detail.InstructionOperator#execute）<br>调用自定义的 Operator 实现类中的模板方法。</p>
<h2 id="QLExpress-Spring"><a href="#QLExpress-Spring" class="headerlink" title="QLExpress &amp; Spring"></a>QLExpress &amp; Spring</h2><p>引入依赖：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.alibaba&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;QLExpress&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;3.2.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>QLExpress脚本中所需的所有对象都需要通过<strong>上下文</strong>来传递，换言之，需要将这个<strong>上下文</strong>接入到 Spring 的上下文中。<br>第一种方式是手动注入 Bean：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">@RunWith(SpringRunner.class)</span><br><span class="line">@SpringBootTest(classes = &#123;SpringexpressdemoApplication.class&#125;)// 指定启动类</span><br><span class="line">public class SpringTest &#123;</span><br><span class="line"></span><br><span class="line">    @Resource</span><br><span class="line">    private CancelService cancelService;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void testDirect() throws Exception &#123;</span><br><span class="line">        ExpressRunner runner = new ExpressRunner();</span><br><span class="line">        DefaultContext&lt;String, Object&gt; context = new DefaultContext&lt;&gt;();</span><br><span class="line">        context.put(&quot;cancelService&quot;, cancelService);</span><br><span class="line">        context.put(&quot;orderId&quot;, 1);</span><br><span class="line">        Object result = runner.execute(&quot;cancelService.cancel(orderId)&quot;, context, null, true, false);</span><br><span class="line">        System.out.println(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Service</span><br><span class="line">public class CancelService &#123;</span><br><span class="line"></span><br><span class="line">    public boolean cancel(Long orderId) &#123;</span><br><span class="line">        System.out.println(&quot;订单[&quot; + orderId + &quot;]已被取消。&quot;);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>或者也可以通过对 QLExpressRunner 和 IExpressContext 做一个简单的封装来实现：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line">@RunWith(SpringRunner.class)</span><br><span class="line">@SpringBootTest(classes = &#123;SpringexpressdemoApplication.class&#125;)// 指定启动类</span><br><span class="line">public class SpringTest &#123;</span><br><span class="line"></span><br><span class="line">    @Resource</span><br><span class="line">    private QLExpressRunner runner;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void testSpringContext() throws Exception &#123;</span><br><span class="line">        Map&lt;String, Object&gt; context = new HashMap&lt;&gt;();</span><br><span class="line">        context.put(&quot;orderId&quot;, 1);</span><br><span class="line">        Object result = runner.execute(&quot;cancelService.cancel(orderId)&quot;, context);</span><br><span class="line">        System.out.println(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public class QLExpressContext extends HashMap&lt;String, Object&gt; implements IExpressContext&lt;String, Object&gt; &#123;</span><br><span class="line"></span><br><span class="line">    private ApplicationContext context;</span><br><span class="line"></span><br><span class="line">    public QLExpressContext(ApplicationContext context) &#123;</span><br><span class="line">        this.context = context;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public QLExpressContext(Map&lt;String, Object&gt; properties, ApplicationContext context) &#123;</span><br><span class="line">        super(properties);</span><br><span class="line">        this.context = context;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Object get(Object name) &#123;</span><br><span class="line">        Object result;</span><br><span class="line">        result = super.get(name);</span><br><span class="line">        try &#123;</span><br><span class="line">            if (result == null &amp;&amp; this.context != null &amp;&amp; this.context.containsBean((String) name)) &#123;</span><br><span class="line">                //如果在Spring容器中包含bean，则返回String的Bean</span><br><span class="line">                result = this.context.getBean((String) name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            throw new RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Object put(String name, Object object) &#123;</span><br><span class="line">        throw new RuntimeException(&quot;未实现&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Component</span><br><span class="line">public class QLExpressRunner implements ApplicationContextAware &#123;</span><br><span class="line"></span><br><span class="line">    private Logger logger = LoggerFactory.getLogger(QLExpressRunner.class);</span><br><span class="line"></span><br><span class="line">    private static final ExpressRunner RUNNER;</span><br><span class="line"></span><br><span class="line">    private static boolean isInitialRunner = false;</span><br><span class="line"></span><br><span class="line">    private ApplicationContext applicationContext;</span><br><span class="line"></span><br><span class="line">    private static final Map&lt;String, Object&gt; EMPTY_CLIENT_CONTEXT = new HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    static &#123;</span><br><span class="line">        RUNNER = new ExpressRunner();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @param statement 需要执行的语句</span><br><span class="line">     * @param context 上下文</span><br><span class="line">     */</span><br><span class="line">    @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">    public Object execute(String statement, Map&lt;String, Object&gt; context) throws Exception &#123;</span><br><span class="line">        initRunner();</span><br><span class="line">        IExpressContext expressContext = new QLExpressContext(context != null ? context : EMPTY_CLIENT_CONTEXT, applicationContext);</span><br><span class="line">        statement = initStatement(statement);</span><br><span class="line">        try &#123;</span><br><span class="line">            return RUNNER.execute(statement, expressContext, null, true, false);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            logger.error(&quot;QLExpress执行出错&quot;, e);</span><br><span class="line">        &#125;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 在此处把一些中文符号替换成英文符号</span><br><span class="line">     */</span><br><span class="line">    private String initStatement(String statement) &#123;</span><br><span class="line">        return statement.replace(&quot;（&quot;, &quot;(&quot;).replace(&quot;）&quot;, &quot;)&quot;).replace(&quot;；&quot;, &quot;;&quot;).replace(&quot;，&quot;, &quot;,&quot;).replace(&quot;“&quot;, &quot;\&quot;&quot;).replace(&quot;”&quot;, &quot;\&quot;&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void initRunner() &#123;</span><br><span class="line">        if (isInitialRunner) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        synchronized (RUNNER) &#123;</span><br><span class="line">            if (isInitialRunner) &#123;</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">            try &#123;</span><br><span class="line">                //在此可以加入预定义函数</span><br><span class="line">                // 1、令原有业务方法可以通过更容易理解的中文脚本语言调用</span><br><span class="line">                // cancelService.cancel(orderId) -&gt; 取消订单(orderId)</span><br><span class="line">                RUNNER.addFunctionOfServiceMethod(&quot;取消订单&quot;,</span><br><span class="line">                        applicationContext.getBean(&quot;cancelService&quot;), &quot;cancel&quot;, new Class[]&#123;Long.class&#125;, null);</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                throw new RuntimeException(&quot;初始化失败表达式&quot;, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        isInitialRunner = true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void setApplicationContext(ApplicationContext aContext)</span><br><span class="line">            throws BeansException &#123;</span><br><span class="line">        applicationContext = aContext;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="优化-脚本缓存"><a href="#优化-脚本缓存" class="headerlink" title="优化 - 脚本缓存"></a>优化 - 脚本缓存</h2><p><code>ExpressRunner#execute(String expressString, IExpressContext&lt;String, Object&gt; context, List&lt;String&gt; errorList, boolean isCache, boolean isTrace)</code><br>execute 方法的第四个参数表明是否使用 Cache 中的指令集参数，它可以缓存单词分解、单词类型分析、语法分析、生成运行期指令集合这四个过程的执行结果，即缓存编译的指令，从而第二次执行时可以直接使用这些指令，从而提升性能。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ExpressRunner runner = new ExpressRunner();</span><br><span class="line">String express = &quot;10 * 10 + 1 + 2 * 3 + 5 * 2&quot;;</span><br><span class="line">int num = 100000;</span><br><span class="line">runner.execute(express, null, null, true, false);</span><br><span class="line">long start = System.currentTimeMillis();</span><br><span class="line">for (int i = 0; i &lt; num; i++) &#123;</span><br><span class="line">    runner.execute(express, null, null, true, false);</span><br><span class="line">&#125;</span><br><span class="line">System.out.println(&quot;执行&quot; + num + &quot;次\&quot;&quot; + express + &quot;\&quot; 耗时：&quot;</span><br><span class="line">        + (System.currentTimeMillis() - start));</span><br></pre></td></tr></table></figure>

<p>以上代码使用了缓存，运行时间在百毫秒级，但是如果关掉缓存，速度会直接降低到近 10 秒。</p>
<p>另外，上边代码中，脚本默认加载在<strong>本地缓存</strong>（是个 Map），如果有比较高的脚本隔离性和安全性需求，可以考虑<strong>将脚本缓存到外部缓存处理器</strong>上：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">ExpressRunner runner = new ExpressRunner();</span><br><span class="line">//ExpressRemoteCacheRunner将编译生成的指令集合放到了一个外部缓存中，保证只能执行原有脚本内容，且脚本之间相互隔离</span><br><span class="line">ExpressRemoteCacheRunner cacheRunner = new LocalExpressCacheRunner(runner);</span><br><span class="line">cacheRunner.loadCache(&quot;计算平均成绩&quot;, &quot;(语文+数学+英语)/3.0&quot;);</span><br><span class="line">cacheRunner.loadCache(&quot;是否优秀&quot;, &quot;计算平均成绩&gt;90&quot;);</span><br><span class="line"></span><br><span class="line">IExpressContext&lt;String, Object&gt; context = new DefaultContext&lt;String, Object&gt;();</span><br><span class="line">context.put(&quot;语文&quot;, 88);</span><br><span class="line">context.put(&quot;数学&quot;, 99);</span><br><span class="line">context.put(&quot;英语&quot;, 95);</span><br><span class="line">System.out.println(cacheRunner.execute(&quot;计算平均成绩&quot;, context, null, false, false, null));</span><br><span class="line">try &#123;</span><br><span class="line">    System.out.println(cacheRunner.execute(&quot;计算平均成绩&gt;90&quot;, context, null, false, false, null));</span><br><span class="line">&#125; catch (Exception e) &#123;</span><br><span class="line">    System.out.println(&quot;ExpressRemoteCacheRunner只支持预先加载的脚本内容&quot;);</span><br><span class="line">&#125;</span><br><span class="line">try &#123;</span><br><span class="line">    System.out.println(cacheRunner.execute(&quot;是否优秀&quot;, context, null, false, false, null));</span><br><span class="line">&#125; catch (Exception e) &#123;</span><br><span class="line">    System.out.println(&quot;ExpressRemoteCacheRunner不支持脚本间的相互调用&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用外部缓存脚本可以带来以下好处：</p>
<ul>
<li>隔离性：一个脚本内无法使用另一个脚本；</li>
<li>安全性（独立性）：只能使用预加载的脚本，execute 执行的脚本不会被加载到缓存中，这减少了脚本被篡改的可能。</li>
</ul>
<p>但是同样会削弱复用性，因为脚本不能利用其它脚本，只能使用预定义的系统函数。</p>
<p>需要注意的是，缓存存在于<code>ExpressRunner#expressInstructionSetCache</code>中，务必要保证<code>ExpressRunner</code>的<strong>单例性</strong>，否则缓存将没有意义。</p>
<h2 id="优化-对象池"><a href="#优化-对象池" class="headerlink" title="优化 - 对象池"></a>优化 - 对象池</h2><p>几乎所有动态脚本语言在运行时都会创建很多对象，然后执行完毕后等着被 GC 回收掉，在多线程运行的环境下，CPU 和内容容易被消耗殆尽。一种可行的优化方式是引入对象池。<br>具体地说，就是在执行指令集时，从对象池中获取对象的存储空间，而不是直接创建对象。</p>
<p><img src="/imgs/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E/QLExpress%E7%B1%BB%E5%9B%BE.png" alt="QLExpress类图" title="QLExpress类图"></p>
<ul>
<li>每次获取对象的时候，不是直接创建对象，而是从缓冲区获取一个 OperateDataField，成员变量被赋值；</li>
<li>每次脚本运行完、资源要被回收的时候，会把这些 OperateDataField 会被显式置为 null，使所有的外部链接对象被 java 虚拟机马上释放。</li>
<li>缓冲区空间是有限的，且不会动态伸缩，如果超过了允许范围，fetchOperateDataField 会直接调用 new OperateDataField(Object aFieldObject,String aFieldName)返回，回收内存也就只能等 jvm 定期去 gc 了。</li>
</ul>
<h2 id="实践-显示出错信息"><a href="#实践-显示出错信息" class="headerlink" title="实践 - 显示出错信息"></a>实践 - 显示出错信息</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">String text = &quot;100 &lt; 99 and 100 &lt;= 99 and 100 &gt; 1&quot;;</span><br><span class="line">// 将操作符替换成中文</span><br><span class="line">text = text.replaceAll(&quot;&lt;=&quot;, &quot;小于或等于&quot;)</span><br><span class="line">        .replaceAll(&quot;&lt;&quot;, &quot;小于&quot;)</span><br><span class="line">        .replaceAll(&quot;&gt;&quot;, &quot;大于&quot;);</span><br><span class="line">ExpressRunner runner = new ExpressRunner();</span><br><span class="line">runner.setShortCircuit(true);</span><br><span class="line">// 指定操作符的别名，注意最后一个参数指定了操作符计算失败时的返回信息</span><br><span class="line">runner.addOperatorWithAlias(&quot;小于&quot;, &quot;&lt;&quot;, &quot;$1 小于 $2&quot;);</span><br><span class="line">runner.addOperatorWithAlias(&quot;小于或等于&quot;, &quot;&lt;=&quot;, &quot;$1 小于 $2&quot;);</span><br><span class="line">runner.addOperatorWithAlias(&quot;大于&quot;, &quot;&gt;&quot;, &quot;$1 小于 $2&quot;);</span><br><span class="line"></span><br><span class="line">// 如果计算发现不满足条件，则将操作符对应的errorInfo添加到下面这个list里</span><br><span class="line">List&lt;String&gt; errorInfo = new ArrayList&lt;&gt;();</span><br><span class="line">IExpressContext&lt;String, Object&gt; expressContext = new DefaultContext&lt;&gt;();</span><br><span class="line">boolean result = (boolean) runner.execute(text, expressContext, errorInfo, true, false);</span><br><span class="line">if (result) &#123;</span><br><span class="line">    System.out.println(&quot;result is success!&quot;);</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    System.out.println(&quot;result is fail!&quot;);</span><br><span class="line">    for (String error : errorInfo) &#123;</span><br><span class="line">        error = error.replaceAll(&quot;小于&quot;, &quot;&lt;&quot;).replaceAll(&quot;小于或等于&quot;, &quot;&lt;=&quot;).replaceAll(&quot;大于&quot;, &quot;&gt;&quot;);</span><br><span class="line">        System.out.println(error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>OperatorBase.execute</code>执行计算后，如果结果是 Boolean 且值为 false，说明未满足要求，于是将 errorInfo 添加到参数的<code>errorList</code>中返回。</p>
<h2 id="实践-短路"><a href="#实践-短路" class="headerlink" title="实践 - 短路"></a>实践 - 短路</h2><p>仍然是上面那个例子，注意<code>runner.setShortCircuit(true);</code>这行代码指定了指令集执行的短路特性。<br><code>OperatorInstructionFactory#createInstruction</code>构建指令集时，如果判断是短路的，则在对应指令后面加入一条条件跳转指令（<code>InstructionGoToWithCondition</code>）：</p>
<ul>
<li>如果<code>&amp;&amp;</code>计算的结果是 false 则跳转到指令集的末尾；</li>
<li><code>||</code>相反、是计算结果为 true 的时候才会跳转到末尾。</li>
</ul>
<h2 id="实践-高精度计算"><a href="#实践-高精度计算" class="headerlink" title="实践 - 高精度计算"></a>实践 - 高精度计算</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">String expression = &quot;a = (b.subtract(c)).divide(d.subtract(c), java.math.BigDecimal.ROUND_HALF_UP);&quot;;</span><br><span class="line">ExpressRunner runner = new ExpressRunner();</span><br><span class="line">IExpressContext&lt;String, Object&gt; context =  new DefaultContext&lt;&gt;();</span><br><span class="line">context.put(&quot;b&quot;, new BigDecimal(&quot;0.1694915254237288&quot;));</span><br><span class="line">context.put(&quot;c&quot;, new BigDecimal(&quot;0.15384615384615385&quot;));</span><br><span class="line">context.put(&quot;d&quot;, new BigDecimal(&quot;1&quot;));</span><br><span class="line">BigDecimal result = (BigDecimal) runner.execute(expression, context, null, true, false);</span><br><span class="line">System.out.println(result);</span><br></pre></td></tr></table></figure>

<p>上边是直接采用原生 JavaAPI 的写法，非常臃肿，实际上<code>ExpressRunner</code>已经提供了高精度的一个简单开关：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">String expression = &quot;a=(b-c)/(d-c)&quot;;</span><br><span class="line">// 第一个参数为true开启高精度计算</span><br><span class="line">ExpressRunner runner = new ExpressRunner(true, false);</span><br><span class="line">DefaultContext&lt;String, Object&gt; context = new DefaultContext&lt;&gt;();</span><br><span class="line">context.put(&quot;b&quot;, new BigDecimal(&quot;0.1694915254237288&quot;));</span><br><span class="line">context.put(&quot;c&quot;, new BigDecimal(&quot;0.15384615384615385&quot;));</span><br><span class="line">context.put(&quot;d&quot;, new BigDecimal(&quot;1&quot;));</span><br><span class="line">Object result = runner.execute(expression, context, null, false, false);</span><br><span class="line">System.out.println(result);</span><br></pre></td></tr></table></figure>

<p>相对原生 API 来说简洁了一些，但是也少了很多灵活性，需要注意以下几点区别：</p>
<ul>
<li>QLExpress 中精度控制为<code>RoundingMode=HALF_UP</code>；</li>
<li>QLExpress 中大数计算精确到小数点后 10 位，即<code>scale=10</code>。</li>
</ul>
<h2 id="实践-方法绑定"><a href="#实践-方法绑定" class="headerlink" title="实践 - 方法绑定"></a>实践 - 方法绑定</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">String express = &quot;阶梯1 = 阶梯(0.0,100.0,0.2);阶梯2 = 阶梯(100.0,200.0,0.15);阶梯3 = 阶梯(200.0,10000.0,0.1);阶梯取值(220,阶梯1,阶梯2,阶梯3)&quot;;</span><br><span class="line">ExpressRunner runner = new ExpressRunner(false, true);</span><br><span class="line">DefaultContext&lt;String, Object&gt; context = new DefaultContext&lt;String, Object&gt;();</span><br><span class="line">// 定义方法的别名</span><br><span class="line">runner.addFunctionOfClassMethod(&quot;阶梯&quot;, &quot;full.path.to.Step&quot;, &quot;createStep&quot;, new Class[]&#123;double.class, double.class, double.class&#125;, null);</span><br><span class="line">runner.addFunctionOfClassMethod(&quot;阶梯取值&quot;, &quot;full.path.to.Step&quot;, &quot;chooseStep&quot;, new Class[]&#123;double.class, Step.class, Step.class, Step.class&#125;, null);</span><br><span class="line">Object r = runner.execute(express, context, null, false, true);</span><br><span class="line">System.out.println(r);</span><br></pre></td></tr></table></figure>

<p>下面这个类中定义了上边用到的一些基础函数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">public class Step &#123;</span><br><span class="line"></span><br><span class="line">    private double min;</span><br><span class="line">    private double max;</span><br><span class="line">    private double value;</span><br><span class="line"></span><br><span class="line">    public double getMin() &#123;</span><br><span class="line">        return min;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setMin(double min) &#123;</span><br><span class="line">        this.min = min;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public double getMax() &#123;</span><br><span class="line">        return max;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setMax(double max) &#123;</span><br><span class="line">        this.max = max;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public double getValue() &#123;</span><br><span class="line">        return value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setValue(double value) &#123;</span><br><span class="line">        this.value = value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static Step createStep(double _min, double _max, double _value) &#123;</span><br><span class="line">        Step step = new Step();</span><br><span class="line">        step.min = _min;</span><br><span class="line">        step.max = _max;</span><br><span class="line">        step.value = _value;</span><br><span class="line">        return step;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static double chooseStep(double input, Step step1, Step step2, Step step3) &#123;</span><br><span class="line">        Step[] steps = &#123;step1, step2, step3&#125;;</span><br><span class="line">        for (Step step : steps) &#123;</span><br><span class="line">            if (step.min &lt;= input &amp;&amp; step.max &gt;= input) &#123;</span><br><span class="line">                return step.value;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return -1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h1 id="技术选型及实践"><a href="#技术选型及实践" class="headerlink" title="技术选型及实践"></a>技术选型及实践</h1><h2 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h2><ol>
<li>易于管理<br>理想情况下，研发人员开发完毕后，管理完全可以由业务人员来实施，包括随时上下线、修改规则的优先级关系等。</li>
<li>减少侵入性<br>规则引擎管理的是业务流程，因此想要做到对业务流程零侵入几乎是不可能的，但是我们还是希望尽量能减少对业务代码的修改，至少不必将所有 if-else 都重写一遍。</li>
<li>支持线程池</li>
<li>可以打日志，且包含 traceId</li>
<li>支持 Spring</li>
<li>支持SpringBoot</li>
</ol>
<h2 id="比较"><a href="#比较" class="headerlink" title="比较"></a>比较</h2><ul>
<li>| 易用 | 侵入性 | 扩展</li>
<li>| - | - | -<br>手动实现规则 | 低（维护到后期往往会出现一大堆嵌套的 if-else、导致业务规则之间的边界模糊） | 强（完全自己实现） | 高（可以利用设计模式来提高扩展性）<br>QLExpress | 高（语法与 Java 的基本一致） | 低（原业务逻辑中的方法可以直接搬到 QLExpress 脚本里用，只需要引入一个 jar 包） | 高（本身是一个脚本引擎有很高的可扩展性，且通过把业务规则模块化可以不断复用）<br>Drools | 低（增加了很多配置文件、规则文件，语法有点奇怪，且需要对 Drools 原理有所了解，不然规则执行效率可能会不高） | 强（需要完全按照 Drools 的语法编写业务逻辑，要引入一堆 jar 包、一堆配置） | 低（需要严格按照 Drools 规定的语法编写业务逻辑）</li>
</ul>
<h1 id="附-Drools"><a href="#附-Drools" class="headerlink" title="附 - Drools"></a>附 - Drools</h1><h2 id="规则管理"><a href="#规则管理" class="headerlink" title="规则管理"></a>规则管理</h2><p>一些复杂的业务一般包含多个规则、多条执行路径，管理时可能会出现以下几个问题：</p>
<ol>
<li>优先级问题<br>比如有两条规则是”满 30 元减 10 元”、”满 50 元减 20 元”，但是用户买了 50 块的东西，这种情况下如何编排规则作用的优先级？还是说两者同时作用？</li>
<li>冲突问题<br>有两条规则”伤害致人死亡，严重者可能判死刑”和”未满 18 岁，不能判处死刑”，那么系统应该如何判定未成年人的杀人罪？</li>
<li>规则列表管理问题<br>虽然不必具有普适性，规则模型的设计必须要覆盖我们所有可能碰到的业务场景。<br>业务人员一般比较熟悉 excel 表格，而不乐于编辑繁琐的规则脚本，所以有必要提供一种映射规则，比如 Drools 的决策表，实际上需要先被框架翻译成<code>.drl</code>脚本才能生效，所以，我们在设计规则引擎功能时，可以为业务人员提供一个规则编辑的表单界面，并且提供上传决策表的功能。</li>
</ol>
<h2 id="概念定义"><a href="#概念定义" class="headerlink" title="概念定义"></a>概念定义</h2><p>Drools 中，一条规则包含<code>attributes</code>、<code>Left Hand Side</code>（<code>LHS</code>）和<code>Right Hand Side</code>（<code>RHS</code>）：</p>
<ul>
<li><p><code>attributes</code><br>Drools 中的 attributes 包括：salience、agenda-group、no-loop、auto-focus、duration、activation-group。</p>
</li>
<li><p><code>LHS</code>和<code>RHS</code><br><code>LHS</code>由一个或多个<code>Conditions</code>组成。当所有的条件<code>Conditions</code>都满足并为真时，<code>RHS</code>将被执行，因此<code>RHS</code>被称为<code>Consequence</code>。</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if($&#123;LHS&#125;) &#123;</span><br><span class="line">    $&#123;RHS&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h2><p>引入依赖：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&lt;drools.version&gt;7.29.0.Final&lt;/drools.version&gt;</span><br><span class="line">&lt;!--Drools--&gt;</span><br><span class="line">&lt;!--kie api 用于构建kie虚拟文件系统，关联decisiontable和drl文件--&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.kie&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;kie-api&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;$&#123;drools.version&#125;&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;!--drools core 包含RETE引擎和LEAPS引擎--&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.drools&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;drools-core&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;$&#123;drools.version&#125;&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.drools&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;drools-compiler&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;$&#123;drools.version&#125;&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;!--决策表依赖--&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.drools&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;drools-decisiontables&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;$&#123;drools.version&#125;&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.drools&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;drools-templates&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;$&#123;drools.version&#125;&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>使用 kmodule 配置 drools 规则，文件位置为<code>/resources/META-INF/kmodule.xml</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;kmodule xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">         xmlns=&quot;http://www.drools.org/xsd/kmodule&quot;&gt;</span><br><span class="line">    &lt;!-- name：唯一标识 packages：资源文件所在的目录 --&gt;</span><br><span class="line">    &lt;kbase name=&quot;testBase&quot; packages=&quot;com.tallate.drools.rule.test&quot;&gt;</span><br><span class="line">        &lt;!-- name：唯一标识 --&gt;</span><br><span class="line">        &lt;ksession name=&quot;testSession&quot;/&gt;</span><br><span class="line">    &lt;/kbase&gt;</span><br><span class="line">&lt;/kmodule&gt;</span><br></pre></td></tr></table></figure>

<p>定义规则，文件位置为<code>/resources/com/tallate/drools/rule/test/test.drl</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">// 指定命名空间，和java中的包名无关，也不必对应物理路径</span><br><span class="line">package com.tallate.drools</span><br><span class="line"></span><br><span class="line">// import要使用的Java类</span><br><span class="line">import com.tallate.drools.bean.User;</span><br><span class="line"></span><br><span class="line">// 规则名，不可重复</span><br><span class="line">rule &quot;unexisted condition&quot;</span><br><span class="line">    // 定义规则的优先级</span><br><span class="line">    salience 10</span><br><span class="line">    when</span><br><span class="line">        // LHS部分，定义规则条件，即是否存在姓名为&quot;Mike&quot;的User类型的Fact对象</span><br><span class="line">        not(User(name == &quot;Mike&quot;));</span><br><span class="line">    then</span><br><span class="line">        // RHS部分，定义当规则满足后执行的操作，可以直接写Java代码，这里逻辑是插入一个新对象</span><br><span class="line">        System.out.println(&quot;User unexisted&quot;);</span><br><span class="line">        User user = new User();</span><br><span class="line">        user.setName(&quot;Mike&quot;);</span><br><span class="line">        System.out.println(user);</span><br><span class="line">        insert(user);</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">rule &quot;existed condition&quot;</span><br><span class="line">    salience 10</span><br><span class="line">    when</span><br><span class="line">        exists(User(name == &quot;Mike&quot;))</span><br><span class="line">    then</span><br><span class="line">        System.out.println(&quot;User existed&quot;);</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<p>上面引入了一个 Bean，需要提供 getter&#x2F;setter，其定义如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">public class User &#123;</span><br><span class="line"></span><br><span class="line">    private String name;</span><br><span class="line"></span><br><span class="line">    private int age;</span><br><span class="line"></span><br><span class="line">    private List&lt;String&gt; cards;</span><br><span class="line"></span><br><span class="line">    public String getName() &#123;</span><br><span class="line">        return name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public User setName(String name) &#123;</span><br><span class="line">        this.name = name;</span><br><span class="line">        return this;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public int getAge() &#123;</span><br><span class="line">        return age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public User setAge(int age) &#123;</span><br><span class="line">        this.age = age;</span><br><span class="line">        return this;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public List&lt;String&gt; getCards() &#123;</span><br><span class="line">        return cards;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public User setCards(List&lt;String&gt; cards) &#123;</span><br><span class="line">        this.cards = cards;</span><br><span class="line">        return this;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public String toString() &#123;</span><br><span class="line">        return new StringJoiner(&quot;, &quot;, User.class.getSimpleName() + &quot;[&quot;, &quot;]&quot;)</span><br><span class="line">                .add(&quot;name=&#x27;&quot; + name + &quot;&#x27;&quot;)</span><br><span class="line">                .add(&quot;age=&quot; + age)</span><br><span class="line">                .add(&quot;cards=&quot; + cards)</span><br><span class="line">                .toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动规则引擎：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public static void main(String[] args) &#123;</span><br><span class="line">    KieContainer kc = KieServices.Factory.get().getKieClasspathContainer();</span><br><span class="line">    System.out.println(kc.verify().getMessages());</span><br><span class="line">    execute(kc);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private static void execute(KieContainer kc) &#123;</span><br><span class="line">    KieSession kieSession = kc.newKieSession(&quot;testSession&quot;);</span><br><span class="line">    // 可以插入Fact对象到Working Memory</span><br><span class="line">    kieSession.insert(new User().setName(&quot;Joe&quot;).setAge(1));</span><br><span class="line">    kieSession.fireAllRules();</span><br><span class="line">    kieSession.dispose();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/imgs/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E/Drools%E4%BE%8B%E5%AD%90%E7%9A%84%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B.png" alt="Drools例子的执行过程" title="Drools例子的执行过程"></p>
<h2 id="决策表的使用"><a href="#决策表的使用" class="headerlink" title="决策表的使用"></a>决策表的使用</h2><ul>
<li>决策表一般使用 xlsx、csv 格式表示，相对来说可读性会更高；</li>
<li>决策表与上述的 drl 并无本质区别，实际上运行时决策表会被翻译成 drl 再实际加载到推理机中使用。</li>
</ul>
<p>首先在<code>kmodule.xml</code>文件中引入 excel 文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;kbase name=&quot;testDecisionTable&quot; packages=&quot;drools.decisiontable&quot;&gt;</span><br><span class="line">    &lt;ksession name=&quot;testDecisionTableSession&quot;/&gt;</span><br><span class="line">&lt;/kbase&gt;</span><br></pre></td></tr></table></figure>

<p>然后在<code>/resources/drools/decisiontable</code>目录下增加一个 rule.xlsx 文件：</p>
<table>
<thead>
<tr>
<th></th>
<th>RuleSet</th>
<th>mydecision</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td>Import</td>
<td>com.tallate.drools.bean.User</td>
</tr>
<tr>
<td></td>
<td>Notes</td>
<td>test decision table</td>
</tr>
<tr>
<td></td>
<td>RuleTable TestTable</td>
<td></td>
</tr>
<tr>
<td></td>
<td>CONDITION</td>
<td>ACTION</td>
</tr>
<tr>
<td></td>
<td>p:User()</td>
<td></td>
</tr>
<tr>
<td></td>
<td>name&#x3D;&#x3D;”$param”</td>
<td>System.out.println(“$param”);</td>
</tr>
<tr>
<td>注释</td>
<td>入参</td>
<td>动作</td>
</tr>
<tr>
<td>hello</td>
<td>Mike</td>
<td>10</td>
</tr>
<tr>
<td>goodbye</td>
<td>Joe</td>
<td>11</td>
</tr>
</tbody></table>
<ul>
<li>第一行，类似 drl 中的 package</li>
<li>第二行，import 使用到的 Java 类</li>
<li>第三行，决策表说明</li>
<li>第四行，指定这是一个决策表</li>
<li>第五行，Condition表示此列是条件，Action表示具体的操作，Action可以有多个列， 单个Action里的多个操作用逗号分隔，末尾要加分号</li>
<li>第六行，紧挨着 Condition 的一行，可以在这里声明下面要用的到对象，对应 drl 文件里的$student:Student()</li>
<li>第七行，如<code>user.getAge()==$param</code>对应 drl 里的<code>age==12</code>，这里<code>$param</code>是对应列每个单元格的值。注意：针对于非字符串，如整数，小数等，可以直接使用<code>$param</code>，但是如果单元格里是字符串，则需要加双引号；如果有多个值，可以用逗号隔开，然后使用<code>$1,$2</code>来引用变量值。</li>
<li>第八行，注释行</li>
<li>下面的每一行，即这些条件和动作具体的取值了</li>
</ul>
<p>下面附上源文件：<br><a href="/imgs/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E/rule.xlsx">rule.xlsx</a></p>
<h2 id="使用原生API"><a href="#使用原生API" class="headerlink" title="使用原生API"></a>使用原生API</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">// 1.获取一个KieServices：KieServices是kie的整体入口，可以用来创建Container,resource,fileSystem等</span><br><span class="line">KieServices kieServices = KieServices.Factory.get();</span><br><span class="line"></span><br><span class="line">// 2.创建kiemodule.xml对应的class，可以不用xml文件的方式来构建</span><br><span class="line">KieModuleModel kieModuleModel = kieServices.newKieModuleModel();</span><br><span class="line"></span><br><span class="line">// 3.创建KieFileSystem虚拟文件系统：KieFileSystem是一个完整的文件系统,包括资源和组织结构</span><br><span class="line">KieFileSystem kieFileSystem = kieServices.newKieFileSystem();</span><br><span class="line"></span><br><span class="line">// 4.添加具体的KieBase标签</span><br><span class="line">KieBaseModel kieBaseModel = kieModuleModel.newKieBaseModel(&quot;mydecision&quot;).</span><br><span class="line">        // kie fileSystem 中资源文件的文件夹</span><br><span class="line">        addPackage(&quot;mydecision&quot;);</span><br><span class="line">// &lt;KieBase&gt;&lt;/KieBase&gt;标签添加KieSession属性，这里和下面获取KieSession时传的sessionName必须一致</span><br><span class="line">kieBaseModel.newKieSessionModel(&quot;kiession-mydecision&quot;);</span><br><span class="line"></span><br><span class="line">// 5.添加kiemodule.xml文件到虚拟文件系统</span><br><span class="line">String kieModuleModelXml = kieModuleModel.toXML();</span><br><span class="line">// kieModuleModel</span><br><span class="line">kieFileSystem.writeKModuleXML(kieModuleModelXml);</span><br><span class="line"></span><br><span class="line">// 6.把规则文件加载到虚拟文件系统</span><br><span class="line">Resource resource = kieServices.getResources().newClassPathResource(&quot;drools/decisiontable/rule.xlsx&quot;);</span><br><span class="line">String fileName = &quot;mydecision-table.&quot; + resource.getResourceType().getDefaultExtension();</span><br><span class="line">// 这里是把规则文件添加到虚拟系统，第一个参数是文件在虚拟系统中的路径，这里的文件目录和4处的addPackage必须一致，否则失败</span><br><span class="line">String kieFilePath = &quot;src/main/resources/mydecision/&quot; + fileName;</span><br><span class="line">kieFileSystem.write(kieFilePath, resource);</span><br><span class="line"></span><br><span class="line">// 7.构建所有的KieBase并把所有的KieBase添加到仓库里：KieBase就是一个知识仓库，包含了若干的规则、流程、方法等，在Drools中主要就是规则和方法，KieBase本身并不包含运行时的数据之类的，如果需要执行规则KieBase中的规则的话，就需要根据KieBase创建KieSession</span><br><span class="line">// KieBuilder在构建完虚拟文件系统后，会自动创建KieModule，KieModule是一个包含了多个KieBase定义的容器，一般用kmodule.xml来表示</span><br><span class="line">kieServices.newKieBuilder(kieFileSystem).buildAll();</span><br><span class="line">// 创建kie容器：KieContainer是KieBase的容器，它封装了KieModule，注意这里的参数ReleaseId，实际上KieModule都由一个KieRepository管理，用一个ReleaseId作区分</span><br><span class="line">KieContainer kieContainer = kieServices.newKieContainer(kieServices.getRepository().getDefaultReleaseId());</span><br><span class="line"></span><br><span class="line">// 8.从容器中获取一个会话，找不到时会报异常：KieSession是一个与Drools引擎交互的会话，其基于KieBase创建，它会包含运行时数据，包含&quot;事实 Fact&quot;，并对运行时数据事实进行规则运算</span><br><span class="line">KieSession kieSession = kieContainer.newKieSession(&quot;kiession-mydecision&quot;);</span><br><span class="line">kieSession.insert(new User().setName(&quot;Mike&quot;).setAge(21));</span><br><span class="line">kieSession.insert(new User().setName(&quot;Joe&quot;).setAge(20));</span><br><span class="line">kieSession.fireAllRules();</span><br><span class="line">System.out.println(&quot;done&quot;);</span><br></pre></td></tr></table></figure>

<h2 id="LHS"><a href="#LHS" class="headerlink" title="LHS"></a>LHS</h2><ul>
<li><p>package<br>TODO</p>
</li>
<li><p>import</p>
</li>
<li><p>rule</p>
</li>
<li><p>no-loop</p>
</li>
</ul>
<h2 id="RHS"><a href="#RHS" class="headerlink" title="RHS"></a>RHS</h2><p>TODO</p>
<h2 id="Drools-Spring"><a href="#Drools-Spring" class="headerlink" title="Drools + Spring"></a>Drools + Spring</h2><p>TODO</p>
<h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><p>-&gt; org.drools.core.common.DefaultAgenda#getNextFocus<br>-&gt; DefaultAgenda#fireNextItem(AgendaFilter filter, int fireCount, int fireLimit, InternalAgendaGroup group)：执行下一个规则<br>TODO</p>
<h2 id="规则引擎运行原理"><a href="#规则引擎运行原理" class="headerlink" title="规则引擎运行原理"></a>规则引擎运行原理</h2><p>在描述 RETE 算法之前我们必须先解释几个术语。</p>
<ul>
<li>Pattern Matching（模式匹配）：对新的数据和被修改的数据进行规则的匹配；</li>
<li>Inference Engine（推理机）：进行匹配的引擎；</li>
<li>Production Memory（规则 rules）：被访问的规则；</li>
<li>Working Memory（事实 facts）：被推理机进行匹配的数据；</li>
<li>Agenda：负责管理被匹配规则的执行；</li>
</ul>
<p>其中，推理机所采用的模式匹配算法包括：<code>Linear</code>、<code>RETE</code>、<code>Treat</code>、<code>Leaps</code>。</p>
<p><img src="/imgs/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E%E6%9E%B6%E6%9E%84.png" alt="规则引擎架构" title="规则引擎架构"></p>
<p><strong>规则引擎</strong>的大致运行原理：</p>
<ol>
<li>推理机拿到事实（数据）和规则后，进行匹配（利用匹配算法，如 RETE），将匹配的规则和数据传递给 Agenda；</li>
<li>重复第 1 步直到没有匹配项；</li>
<li>由 Agenda 负责规则的执行。规则并不能被直接调用，因为它们不是方法或函数，规则的激发是对 Working Memory 中数据变化的响应（Listening）。数据被插入 Working Memory 后，会和<code>RuleBase</code>中的规则的<code>LHS</code>进行匹配，如果匹配成功则这条规则连同和它匹配的数据（此时称为<code>Activation</code>）一起被放入 Agenda，等待 Agenda 来激活执行规则的<code>RHS</code>，Agenda 会根据冲突解决策略来安排<code>Activation</code>的执行顺序。</li>
</ol>
<h2 id="规则匹配算法-RETE"><a href="#规则匹配算法-RETE" class="headerlink" title="规则匹配算法 - RETE"></a>规则匹配算法 - RETE</h2><p>RETE 算法利用<strong>动态规划</strong>思想来提高规则匹配的效率，复杂的规则会被组织成一张有向无环图，重叠的节点会被合并，合并意味着结果是可以重用的，这些条件判断结果会被保存到缓存中，供其他规则计算时使用。<br>TODO</p>
<h2 id="规则引擎规范-JSR-94"><a href="#规则引擎规范-JSR-94" class="headerlink" title="规则引擎规范 - JSR-94"></a>规则引擎规范 - JSR-94</h2><p>JSR-94 定义了规则引擎的 Java 运行时 API，它并没有规定如何实现，但规范使得代码与规则的底层实现解耦，提升了规则引擎的可移植性。<br>JSR-94 的常见实现是<strong>Drools</strong>。<br>Drools 是基于 RETE 算法实现的规则引擎，遵循 JSR-94 协议提供 OO 接口，更加易于使用。</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><h2 id="方案"><a href="#方案" class="headerlink" title="方案"></a>方案</h2><ol>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/9b67ab434795">再见了 ! if-else ！拥抱规则引擎</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jiqizhixin.com/graph/technologies/30323763-f9cc-4140-b08d-d7595221e704">规则引擎</a></li>
<li><a target="_blank" rel="noopener" href="https://www.ibm.com/developerworks/cn/java/j-java-rules/">Java 规则引擎与其 API(JSR-94)</a></li>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/p/1210000009759304/read">从 0 到 1：构建强大且易用的规则引擎 - 美团</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.im/post/5bd69af1e51d453975303cef">网易考拉规则引擎平台架构设计与实践</a></li>
</ol>
<h2 id="Drools"><a href="#Drools" class="headerlink" title="Drools"></a>Drools</h2><ol>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/yuebintse/p/5767996.html">drools 规则引擎初探</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/yuebintse/p/5768046.html">drools语法介绍</a></li>
<li><a target="_blank" rel="noopener" href="https://www.baeldung.com/drools-spring-integration">Drools Spring Integration</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/kiegroup/drools">github - kiegroup&#x2F;drools</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/MyHerux/drools-springboot">github - MyHerux&#x2F;drools-springboot</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.jboss.org/drools/release/6.4.0.Final/drools-docs/html_single/index.html">Drools Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.jboss.org/drools/release/6.4.0.Final/drools-docs/html_single/index.html#DroolsLanguageReferenceChapter">Drools Documentation - Rule 语法参考</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.jboss.org/drools/release/6.4.0.Final/drools-docs/html_single/index.html#d0e5549">Drools Documentation - Decision Tables in Spreadsheets</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.jboss.org/drools/release/6.4.0.Final/drools-docs/html_single/index.html#ch.kie.spring">Drools Documentation - 整合 Spring</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.jboss.org/drools/release/6.4.0.Final/drools-docs/html_single/index.html#ReteOO">Drools Documentation - Rate 算法</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/3e9afe9e0617">RETE 算法简述 &amp; 实践</a></li>
<li><a target="_blank" rel="noopener" href="https://www.onacademic.com/detail/journal_1000033906327410_4dc2.html">Rete: A fast algorithm for the many pattern&#x2F;many object pattern match problem</a></li>
</ol>
<h2 id="QLExpress-1"><a href="#QLExpress-1" class="headerlink" title="QLExpress"></a>QLExpress</h2><ol>
<li><a target="_blank" rel="noopener" href="https://github.com/alibaba/QLExpress">github - alibaba&#x2F;QLExpress</a></li>
<li><a target="_blank" rel="noopener" href="https://gitee.com/cuibo119/QLExpress">QLExpress基本语法</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/express_wind/article/list/1">express_wind - CSDN</a></li>
<li><a target="_blank" rel="noopener" href="https://yq.aliyun.com/album/130">QLExpress 答疑解惑</a></li>
<li><a target="_blank" rel="noopener" href="https://yq.aliyun.com/articles/700198?spm=a2c4e.11163080.searchblog.9.4ce52ec13r4BQU">QLExpress 代码解读，运行原理解析</a></li>
</ol>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.6.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.6.0/dist/mindmap.min.css">
    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E/" rel="tag"># 规则引擎</a>
              <a href="/tags/Drools/" rel="tag"># Drools</a>
              <a href="/tags/QLExpress/" rel="tag"># QLExpress</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/58b05574.html" rel="prev" title="Lettuce和Jedis">
                  <i class="fa fa-angle-left"></i> Lettuce和Jedis
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/a6d48c65.html" rel="next" title="MySQL3_2索引">
                  MySQL3_2索引 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">tallate</span>
  </div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/tallate" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>


  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"version":"7.1.2","options":null,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.3.0/mermaid.min.js","integrity":"sha256-9y71g5Lz/KLsHjB8uXwnkuWDtAMDSzD/HdIbqhJfTAI="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>





  





</body>
</html>
